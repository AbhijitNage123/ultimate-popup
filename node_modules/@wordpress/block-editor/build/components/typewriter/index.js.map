{"version":3,"sources":["@wordpress/block-editor/src/components/typewriter/index.js"],"names":["isIE","window","navigator","userAgent","indexOf","arrowKeyCodes","Set","UP","DOWN","LEFT","RIGHT","initialTriggerPercentage","useTypewriter","hasSelectedBlock","select","blockEditorStore","node","ownerDocument","defaultView","scrollResizeRafId","onKeyDownRafId","caretRect","onScrollResize","requestAnimationFrame","computeCaretRectangle","onKeyDown","event","cancelAnimationFrame","maintainCaretPosition","keyCode","isSelectionEligibleForScroll","currentCaretRect","has","diff","top","scrollContainer","windowScroll","body","scrollY","scrollTop","scrollContainerY","getBoundingClientRect","relativeScrollPosition","innerHeight","isLastEditableNode","scrollContainerHeight","clientHeight","height","scrollBy","addSelectionChangeListener","addEventListener","computeCaretRectOnSelectionChange","removeEventListener","contains","activeElement","isContentEditable","editableNodes","querySelectorAll","lastEditableNode","length","Typewriter","children","TypewriterOrIEBypass","props"],"mappings":"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","sourcesContent":["/**\n * WordPress dependencies\n */\nimport { useRefEffect } from '@wordpress/compose';\nimport { computeCaretRect, getScrollContainer } from '@wordpress/dom';\nimport { useSelect } from '@wordpress/data';\nimport { UP, DOWN, LEFT, RIGHT } from '@wordpress/keycodes';\n\n/**\n * Internal dependencies\n */\nimport { store as blockEditorStore } from '../../store';\n\nconst isIE = window.navigator.userAgent.indexOf( 'Trident' ) !== -1;\nconst arrowKeyCodes = new Set( [ UP, DOWN, LEFT, RIGHT ] );\nconst initialTriggerPercentage = 0.75;\n\nexport function useTypewriter() {\n\tconst hasSelectedBlock = useSelect( ( select ) =>\n\t\tselect( blockEditorStore ).hasSelectedBlock()\n\t);\n\n\treturn useRefEffect(\n\t\t( node ) => {\n\t\t\tif ( ! hasSelectedBlock ) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst { ownerDocument } = node;\n\t\t\tconst { defaultView } = ownerDocument;\n\n\t\t\tlet scrollResizeRafId;\n\t\t\tlet onKeyDownRafId;\n\n\t\t\tlet caretRect;\n\n\t\t\tfunction onScrollResize() {\n\t\t\t\tif ( scrollResizeRafId ) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tscrollResizeRafId = defaultView.requestAnimationFrame( () => {\n\t\t\t\t\tcomputeCaretRectangle();\n\t\t\t\t\tscrollResizeRafId = null;\n\t\t\t\t} );\n\t\t\t}\n\n\t\t\tfunction onKeyDown( event ) {\n\t\t\t\t// Ensure the any remaining request is cancelled.\n\t\t\t\tif ( onKeyDownRafId ) {\n\t\t\t\t\tdefaultView.cancelAnimationFrame( onKeyDownRafId );\n\t\t\t\t}\n\n\t\t\t\t// Use an animation frame for a smooth result.\n\t\t\t\tonKeyDownRafId = defaultView.requestAnimationFrame( () => {\n\t\t\t\t\tmaintainCaretPosition( event );\n\t\t\t\t\tonKeyDownRafId = null;\n\t\t\t\t} );\n\t\t\t}\n\n\t\t\t/**\n\t\t\t * Maintains the scroll position after a selection change caused by a\n\t\t\t * keyboard event.\n\t\t\t *\n\t\t\t * @param {KeyboardEvent} event Keyboard event.\n\t\t\t */\n\t\t\tfunction maintainCaretPosition( { keyCode } ) {\n\t\t\t\tif ( ! isSelectionEligibleForScroll() ) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tconst currentCaretRect = computeCaretRect( defaultView );\n\n\t\t\t\tif ( ! currentCaretRect ) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\t// If for some reason there is no position set to be scrolled to, let\n\t\t\t\t// this be the position to be scrolled to in the future.\n\t\t\t\tif ( ! caretRect ) {\n\t\t\t\t\tcaretRect = currentCaretRect;\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\t// Even though enabling the typewriter effect for arrow keys results in\n\t\t\t\t// a pleasant experience, it may not be the case for everyone, so, for\n\t\t\t\t// now, let's disable it.\n\t\t\t\tif ( arrowKeyCodes.has( keyCode ) ) {\n\t\t\t\t\t// Reset the caret position to maintain.\n\t\t\t\t\tcaretRect = currentCaretRect;\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tconst diff = currentCaretRect.top - caretRect.top;\n\n\t\t\t\tif ( diff === 0 ) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tconst scrollContainer = getScrollContainer( node );\n\n\t\t\t\t// The page must be scrollable.\n\t\t\t\tif ( ! scrollContainer ) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tconst windowScroll = scrollContainer === ownerDocument.body;\n\t\t\t\tconst scrollY = windowScroll\n\t\t\t\t\t? defaultView.scrollY\n\t\t\t\t\t: scrollContainer.scrollTop;\n\t\t\t\tconst scrollContainerY = windowScroll\n\t\t\t\t\t? 0\n\t\t\t\t\t: scrollContainer.getBoundingClientRect().top;\n\t\t\t\tconst relativeScrollPosition = windowScroll\n\t\t\t\t\t? caretRect.top / defaultView.innerHeight\n\t\t\t\t\t: ( caretRect.top - scrollContainerY ) /\n\t\t\t\t\t  ( defaultView.innerHeight - scrollContainerY );\n\n\t\t\t\t// If the scroll position is at the start, the active editable element\n\t\t\t\t// is the last one, and the caret is positioned within the initial\n\t\t\t\t// trigger percentage of the page, do not scroll the page.\n\t\t\t\t// The typewriter effect should not kick in until an empty page has been\n\t\t\t\t// filled with the initial trigger percentage or the user scrolls\n\t\t\t\t// intentionally down.\n\t\t\t\tif (\n\t\t\t\t\tscrollY === 0 &&\n\t\t\t\t\trelativeScrollPosition < initialTriggerPercentage &&\n\t\t\t\t\tisLastEditableNode()\n\t\t\t\t) {\n\t\t\t\t\t// Reset the caret position to maintain.\n\t\t\t\t\tcaretRect = currentCaretRect;\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tconst scrollContainerHeight = windowScroll\n\t\t\t\t\t? defaultView.innerHeight\n\t\t\t\t\t: scrollContainer.clientHeight;\n\n\t\t\t\t// Abort if the target scroll position would scroll the caret out of\n\t\t\t\t// view.\n\t\t\t\tif (\n\t\t\t\t\t// The caret is under the lower fold.\n\t\t\t\t\tcaretRect.top + caretRect.height >\n\t\t\t\t\t\tscrollContainerY + scrollContainerHeight ||\n\t\t\t\t\t// The caret is above the upper fold.\n\t\t\t\t\tcaretRect.top < scrollContainerY\n\t\t\t\t) {\n\t\t\t\t\t// Reset the caret position to maintain.\n\t\t\t\t\tcaretRect = currentCaretRect;\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tif ( windowScroll ) {\n\t\t\t\t\tdefaultView.scrollBy( 0, diff );\n\t\t\t\t} else {\n\t\t\t\t\tscrollContainer.scrollTop += diff;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t/**\n\t\t\t * Adds a `selectionchange` listener to reset the scroll position to be\n\t\t\t * maintained.\n\t\t\t */\n\t\t\tfunction addSelectionChangeListener() {\n\t\t\t\townerDocument.addEventListener(\n\t\t\t\t\t'selectionchange',\n\t\t\t\t\tcomputeCaretRectOnSelectionChange\n\t\t\t\t);\n\t\t\t}\n\n\t\t\t/**\n\t\t\t * Resets the scroll position to be maintained during a `selectionchange`\n\t\t\t * event. Also removes the listener, so it acts as a one-time listener.\n\t\t\t */\n\t\t\tfunction computeCaretRectOnSelectionChange() {\n\t\t\t\townerDocument.removeEventListener(\n\t\t\t\t\t'selectionchange',\n\t\t\t\t\tcomputeCaretRectOnSelectionChange\n\t\t\t\t);\n\t\t\t\tcomputeCaretRectangle();\n\t\t\t}\n\n\t\t\t/**\n\t\t\t * Resets the scroll position to be maintained.\n\t\t\t */\n\t\t\tfunction computeCaretRectangle() {\n\t\t\t\tif ( isSelectionEligibleForScroll() ) {\n\t\t\t\t\tcaretRect = computeCaretRect( defaultView );\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t/**\n\t\t\t * Checks if the current situation is elegible for scroll:\n\t\t\t * - There should be one and only one block selected.\n\t\t\t * - The component must contain the selection.\n\t\t\t * - The active element must be contenteditable.\n\t\t\t */\n\t\t\tfunction isSelectionEligibleForScroll() {\n\t\t\t\treturn (\n\t\t\t\t\tnode.contains( ownerDocument.activeElement ) &&\n\t\t\t\t\townerDocument.activeElement.isContentEditable\n\t\t\t\t);\n\t\t\t}\n\n\t\t\tfunction isLastEditableNode() {\n\t\t\t\tconst editableNodes = node.querySelectorAll(\n\t\t\t\t\t'[contenteditable=\"true\"]'\n\t\t\t\t);\n\t\t\t\tconst lastEditableNode =\n\t\t\t\t\teditableNodes[ editableNodes.length - 1 ];\n\t\t\t\treturn lastEditableNode === ownerDocument.activeElement;\n\t\t\t}\n\n\t\t\t// When the user scrolls or resizes, the scroll position should be\n\t\t\t// reset.\n\t\t\tdefaultView.addEventListener( 'scroll', onScrollResize, true );\n\t\t\tdefaultView.addEventListener( 'resize', onScrollResize, true );\n\n\t\t\tnode.addEventListener( 'keydown', onKeyDown );\n\t\t\tnode.addEventListener( 'keyup', maintainCaretPosition );\n\t\t\tnode.addEventListener( 'mousedown', addSelectionChangeListener );\n\t\t\tnode.addEventListener( 'touchstart', addSelectionChangeListener );\n\n\t\t\treturn () => {\n\t\t\t\tdefaultView.removeEventListener(\n\t\t\t\t\t'scroll',\n\t\t\t\t\tonScrollResize,\n\t\t\t\t\ttrue\n\t\t\t\t);\n\t\t\t\tdefaultView.removeEventListener(\n\t\t\t\t\t'resize',\n\t\t\t\t\tonScrollResize,\n\t\t\t\t\ttrue\n\t\t\t\t);\n\n\t\t\t\tnode.removeEventListener( 'keydown', onKeyDown );\n\t\t\t\tnode.removeEventListener( 'keyup', maintainCaretPosition );\n\t\t\t\tnode.removeEventListener(\n\t\t\t\t\t'mousedown',\n\t\t\t\t\taddSelectionChangeListener\n\t\t\t\t);\n\t\t\t\tnode.removeEventListener(\n\t\t\t\t\t'touchstart',\n\t\t\t\t\taddSelectionChangeListener\n\t\t\t\t);\n\n\t\t\t\townerDocument.removeEventListener(\n\t\t\t\t\t'selectionchange',\n\t\t\t\t\tcomputeCaretRectOnSelectionChange\n\t\t\t\t);\n\n\t\t\t\tdefaultView.cancelAnimationFrame( scrollResizeRafId );\n\t\t\t\tdefaultView.cancelAnimationFrame( onKeyDownRafId );\n\t\t\t};\n\t\t},\n\t\t[ hasSelectedBlock ]\n\t);\n}\n\nfunction Typewriter( { children } ) {\n\treturn (\n\t\t<div ref={ useTypewriter() } className=\"block-editor__typewriter\">\n\t\t\t{ children }\n\t\t</div>\n\t);\n}\n\n/**\n * The exported component. The implementation of Typewriter faced technical\n * challenges in Internet Explorer, and is simply skipped, rendering the given\n * props children instead.\n *\n * @type {WPComponent}\n */\nconst TypewriterOrIEBypass = isIE ? ( props ) => props.children : Typewriter;\n\n/**\n * Ensures that the text selection keeps the same vertical distance from the\n * viewport during keyboard events within this component. The vertical distance\n * can vary. It is the last clicked or scrolled to position.\n */\nexport default TypewriterOrIEBypass;\n"]}