{"version":3,"sources":["@wordpress/blocks/src/api/templates.js"],"names":["every","map","get","mapValues","isArray","renderToString","convertLegacyBlocks","createBlock","getBlockType","doBlocksMatchTemplate","blocks","template","length","name","innerBlocksTemplate","index","block","innerBlocks","synchronizeBlocksWithTemplate","attributes","blockType","isHTMLAttribute","attributeDefinition","isQueryAttribute","normalizeAttributes","schema","values","value","key","normalizeAttribute","definition","subValues","query","normalizedAttributes","blockName","blockAttributes"],"mappings":"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","sourcesContent":["/**\n * External dependencies\n */\nimport { every, map, get, mapValues, isArray } from 'lodash';\n\n/**\n * WordPress dependencies\n */\nimport { renderToString } from '@wordpress/element';\n\n/**\n * Internal dependencies\n */\nimport { convertLegacyBlocks } from './parser';\nimport { createBlock } from './factory';\nimport { getBlockType } from './registration';\n\n/**\n * Checks whether a list of blocks matches a template by comparing the block names.\n *\n * @param {Array} blocks   Block list.\n * @param {Array} template Block template.\n *\n * @return {boolean} Whether the list of blocks matches a templates.\n */\nexport function doBlocksMatchTemplate( blocks = [], template = [] ) {\n\treturn (\n\t\tblocks.length === template.length &&\n\t\tevery( template, ( [ name, , innerBlocksTemplate ], index ) => {\n\t\t\tconst block = blocks[ index ];\n\t\t\treturn (\n\t\t\t\tname === block.name &&\n\t\t\t\tdoBlocksMatchTemplate( block.innerBlocks, innerBlocksTemplate )\n\t\t\t);\n\t\t} )\n\t);\n}\n\n/**\n * Synchronize a block list with a block template.\n *\n * Synchronizing a block list with a block template means that we loop over the blocks\n * keep the block as is if it matches the block at the same position in the template\n * (If it has the same name) and if doesn't match, we create a new block based on the template.\n * Extra blocks not present in the template are removed.\n *\n * @param {Array} blocks   Block list.\n * @param {Array} template Block template.\n *\n * @return {Array} Updated Block list.\n */\nexport function synchronizeBlocksWithTemplate( blocks = [], template ) {\n\t// If no template is provided, return blocks unmodified.\n\tif ( ! template ) {\n\t\treturn blocks;\n\t}\n\n\treturn map(\n\t\ttemplate,\n\t\t( [ name, attributes, innerBlocksTemplate ], index ) => {\n\t\t\tconst block = blocks[ index ];\n\n\t\t\tif ( block && block.name === name ) {\n\t\t\t\tconst innerBlocks = synchronizeBlocksWithTemplate(\n\t\t\t\t\tblock.innerBlocks,\n\t\t\t\t\tinnerBlocksTemplate\n\t\t\t\t);\n\t\t\t\treturn { ...block, innerBlocks };\n\t\t\t}\n\n\t\t\t// To support old templates that were using the \"children\" format\n\t\t\t// for the attributes using \"html\" strings now, we normalize the template attributes\n\t\t\t// before creating the blocks.\n\n\t\t\tconst blockType = getBlockType( name );\n\t\t\tconst isHTMLAttribute = ( attributeDefinition ) =>\n\t\t\t\tget( attributeDefinition, [ 'source' ] ) === 'html';\n\t\t\tconst isQueryAttribute = ( attributeDefinition ) =>\n\t\t\t\tget( attributeDefinition, [ 'source' ] ) === 'query';\n\n\t\t\tconst normalizeAttributes = ( schema, values ) => {\n\t\t\t\treturn mapValues( values, ( value, key ) => {\n\t\t\t\t\treturn normalizeAttribute( schema[ key ], value );\n\t\t\t\t} );\n\t\t\t};\n\t\t\tconst normalizeAttribute = ( definition, value ) => {\n\t\t\t\tif ( isHTMLAttribute( definition ) && isArray( value ) ) {\n\t\t\t\t\t// Introduce a deprecated call at this point\n\t\t\t\t\t// When we're confident that \"children\" format should be removed from the templates.\n\n\t\t\t\t\treturn renderToString( value );\n\t\t\t\t}\n\n\t\t\t\tif ( isQueryAttribute( definition ) && value ) {\n\t\t\t\t\treturn value.map( ( subValues ) => {\n\t\t\t\t\t\treturn normalizeAttributes(\n\t\t\t\t\t\t\tdefinition.query,\n\t\t\t\t\t\t\tsubValues\n\t\t\t\t\t\t);\n\t\t\t\t\t} );\n\t\t\t\t}\n\n\t\t\t\treturn value;\n\t\t\t};\n\n\t\t\tconst normalizedAttributes = normalizeAttributes(\n\t\t\t\tget( blockType, [ 'attributes' ], {} ),\n\t\t\t\tattributes\n\t\t\t);\n\n\t\t\tconst {\n\t\t\t\tname: blockName,\n\t\t\t\tattributes: blockAttributes,\n\t\t\t} = convertLegacyBlocks( name, normalizedAttributes );\n\n\t\t\treturn createBlock(\n\t\t\t\tblockName,\n\t\t\t\tblockAttributes,\n\t\t\t\tsynchronizeBlocksWithTemplate( [], innerBlocksTemplate )\n\t\t\t);\n\t\t}\n\t);\n}\n"]}